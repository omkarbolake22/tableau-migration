
pipeline {
  agent { label 'Tableau-Schema-Migration-Node' }

  environment {
    AWS_REGION = 'us-east-1'
    ACCOUNT_ID = '180350466832'
    REPO_NAME  = 'tableau-schema-migration'
    REGISTRY   = "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
    ECR_IMAGE  = "${REGISTRY}/${REPO_NAME}:latest"   // or use a commit tag you pushed
  }

  options { timestamps() }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Login to ECR & Pull Image') {
      steps {
        sh '''
          set -e
          aws ecr get-login-password --region "$AWS_REGION" \
            | docker login --username AWS --password-stdin "$REGISTRY"
          docker pull "$ECR_IMAGE"
        '''
      }
    }

    stage('Run inside ECR image') {
  steps {
    script {
      docker.image(env.ECR_IMAGE).inside('-u 0:0') {
        withCredentials([
          string(credentialsId: 'AWS_ACCESS_KEY_ID_EU',     variable: 'AWS_ACCESS_KEY_ID'),
          string(credentialsId: 'AWS_SECRET_ACCESS_KEY_EU', variable: 'AWS_SECRET_ACCESS_KEY'),
          string(credentialsId: 'AWS_SESSION_TOKEN_EU',     variable: 'AWS_SESSION_TOKEN')
        ]) {
          sh '''
            set -euo pipefail

            export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
            export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
            export AWS_SESSION_TOKEN="$AWS_SESSION_TOKEN"
            export AWS_DEFAULT_REGION="$AWS_REGION"

            echo "Workspace in container: $(pwd)"
            ls -la

            # Disable pip progress UI to avoid thread spawn issues
            export PIP_PROGRESS_BAR=off

            # Install your Python deps (requirements.txt exists at repo root)
            ##python3 -m pip install --no-cache-dir --progress-bar off -r requirements.txt

            # Run the script at repo root (singular 'folder')
            echo "Running: python3 -u run_all_json_in_folders_EU.py"
            python3 -u run_all_json_in_folder.py
          '''
        }
      }
    }
  }
}
  }

  post {
    always {
      echo 'Pipeline finished.'
    }
    failure {
      echo 'Deployment failed!'
    }
  }
}
